-- [[ PHARMACII.GG V153 - STABILITY FIXED ]] --

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local VIM = game:GetService("VirtualInputManager")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local Lighting = game:GetService("Lighting")
local LocalPlayer = Players.LocalPlayer

-- [[ SETTINGS & STATE ]] --
local Settings = {
    -- Physics
    FlightTime = 0.9,
    Gravity = 196.2,
    ServerBoost = 50,
    StepSize = 5,
    DunkDistance = 15,
    
    -- Toggles
    BallReach = false,
    ReachDistance = 6, 
    WalkSpeed = 16,
    
    AutoGuard = false,
    AutoGuardKey = Enum.KeyCode.F,
    GuardDelay = 0.0,
    
    AutoPower = true, 
    AutoShoot = true,
    JumpDelay = 0.08,
    
    -- Visuals
    ShowHitboxes = false,
    HBESize = 2,
    HBEEnabled = false,
    HBEVisuals = false,
    AntiKnock = false,
    BigHead = false,
    TruckEnabled = false,
    
    WorldTime = 12,
    Brightness = 2,
    MenuKey = Enum.KeyCode.LeftControl, 
    
    -- UI Colors
    MainColor = Color3.fromRGB(10, 10, 13),      
    ContainerColor = Color3.fromRGB(18, 15, 22), 
    AccentColor = Color3.fromRGB(180, 80, 255),  
    Gradient1 = Color3.fromRGB(140, 40, 220),
    Gradient2 = Color3.fromRGB(200, 100, 255),
    TextColorDim = Color3.fromRGB(255, 255, 255),
    ButtonColor = Color3.fromRGB(25, 25, 28)
}

local UIElements = {Toggles = {}, Sliders = {}, Keybinds = {}}
local SelectedConfig = nil 

-- [[ CONFIG SYSTEM ]] --
local ConfigFileName = "Pharmacii_GG_Configs.json"
local ConfigList = {}

local function SaveConfigs()
    if writefile then writefile(ConfigFileName, HttpService:JSONEncode(ConfigList)) end
end

local function LoadConfigsFromFile()
    if isfile and isfile(ConfigFileName) then
        local success, decoded = pcall(function() return HttpService:JSONDecode(readfile(ConfigFileName)) end)
        if success then ConfigList = decoded end
    end
end

local function ApplyConfig(configName)
    local data = ConfigList[configName]
    if not data then return end
    for key, value in pairs(data) do
        if Settings[key] ~= nil then
            Settings[key] = value
            if UIElements.Toggles[key] then UIElements.Toggles[key](value) end
            if UIElements.Sliders[key] then UIElements.Sliders[key](value) end
        end
    end
    Lighting.ClockTime = Settings.WorldTime
    Lighting.Brightness = Settings.Brightness
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = Settings.WalkSpeed
    end
end

-- [[ UI CONSTRUCTION ]] --
local PlrGui = LocalPlayer:WaitForChild("PlayerGui")
if PlrGui:FindFirstChild("PharmaciiGG") then PlrGui.PharmaciiGG:Destroy() end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "PharmaciiGG"
ScreenGui.DisplayOrder = 999999
ScreenGui.IgnoreGuiInset = true

if gethui then ScreenGui.Parent = gethui()
elseif syn and syn.protect_gui then syn.protect_gui(ScreenGui) ScreenGui.Parent = PlrGui
else ScreenGui.Parent = PlrGui end

-- Main Window
local Main = Instance.new("Frame", ScreenGui)
Main.Name = "Main"
Main.Size = UDim2.new(0, 560, 0, 500) 
Main.Position = UDim2.new(0.5, -280, 0.5, -250)
Main.BackgroundColor3 = Settings.MainColor
Main.BorderSizePixel = 0
Main.Active = true
Main.Draggable = true
Main.ClipsDescendants = false 
Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 14)

local MainStroke = Instance.new("UIStroke", Main)
MainStroke.Color = Color3.fromRGB(40, 35, 50)
MainStroke.Thickness = 1.2
MainStroke.Transparency = 0.5

-- Header
local Header = Instance.new("Frame", Main)
Header.Size = UDim2.new(1, 0, 0, 50)
Header.BackgroundTransparency = 1

local Logo = Instance.new("ImageLabel", Header)
Logo.Size = UDim2.new(0, 36, 0, 36)
Logo.Position = UDim2.new(0, 18, 0.5, -18)
Logo.Image = "rbxassetid://137038623162916"
Logo.BackgroundTransparency = 1

local Title = Instance.new("TextLabel", Header)
Title.Text = "Pharmacii.gg"
Title.Size = UDim2.new(0, 200, 1, 0)
Title.Position = UDim2.new(0, 60, 0, 0)
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 18
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.BackgroundTransparency = 1

-- Tab Area
local TabArea = Instance.new("Frame", Main)
TabArea.Size = UDim2.new(1, -36, 0, 40)
TabArea.Position = UDim2.new(0, 18, 0, 55)
TabArea.BackgroundTransparency = 1

local Pages = {}

local function CreateTab(name, iconId)
    local TabFrame = Instance.new("Frame", TabArea)
    TabFrame.Size = UDim2.new(0, 120, 1, 0)
    TabFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 18)
    Instance.new("UICorner", TabFrame).CornerRadius = UDim.new(0, 10)
    
    local Icon = Instance.new("ImageLabel", TabFrame)
    Icon.Size = UDim2.new(0, 16, 0, 16)
    Icon.Position = UDim2.new(0, 12, 0.5, -8)
    Icon.Image = iconId
    Icon.ImageColor3 = Color3.fromRGB(150, 150, 150)
    Icon.BackgroundTransparency = 1
    
    local Label = Instance.new("TextLabel", TabFrame)
    Label.Text = name
    Label.Size = UDim2.new(1, -40, 1, 0)
    Label.Position = UDim2.new(0, 36, 0, 0)
    Label.TextColor3 = Color3.fromRGB(150, 150, 150)
    Label.Font = Enum.Font.GothamBold
    Label.TextSize = 13
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.BackgroundTransparency = 1
    
    local Button = Instance.new("TextButton", TabFrame)
    Button.Size = UDim2.new(1, 0, 1, 0)
    Button.BackgroundTransparency = 1
    Button.Text = ""
    
    local Page = Instance.new("Frame", Main)
    Page.Size = UDim2.new(1, -36, 1, -115) 
    Page.Position = UDim2.new(0, 18, 0, 105)
    Page.BackgroundTransparency = 1
    Page.Visible = false
    Pages[name] = {Btn = TabFrame, Page = Page, Icon = Icon, Label = Label}
    
    local LeftCol = Instance.new("ScrollingFrame", Page)
    LeftCol.Size = UDim2.new(0.48, 0, 1, 0)
    LeftCol.BackgroundTransparency = 1
    LeftCol.ScrollBarThickness = 2
    LeftCol.ScrollBarImageColor3 = Settings.AccentColor
    LeftCol.AutomaticCanvasSize = Enum.AutomaticSize.Y
    LeftCol.CanvasSize = UDim2.new(0,0,0,0)
    
    local RightCol = Instance.new("ScrollingFrame", Page)
    RightCol.Size = UDim2.new(0.48, 0, 1, 0)
    RightCol.Position = UDim2.new(0.52, 0, 0, 0)
    RightCol.BackgroundTransparency = 1
    RightCol.ScrollBarThickness = 2
    RightCol.ScrollBarImageColor3 = Settings.AccentColor
    RightCol.AutomaticCanvasSize = Enum.AutomaticSize.Y
    RightCol.CanvasSize = UDim2.new(0,0,0,0)
    
    Instance.new("UIListLayout", LeftCol).Padding = UDim.new(0, 12)
    Instance.new("UIListLayout", RightCol).Padding = UDim.new(0, 12)
    Instance.new("UIPadding", LeftCol).PaddingRight = UDim.new(0, 4)
    Instance.new("UIPadding", RightCol).PaddingRight = UDim.new(0, 4)
    
    Button.MouseButton1Click:Connect(function()
        for n, p in pairs(Pages) do
            p.Page.Visible = (n == name)
            p.Btn.BackgroundColor3 = (n == name) and Color3.fromRGB(25, 22, 30) or Color3.fromRGB(15, 15, 18)
            p.Icon.ImageColor3 = (n == name) and Settings.AccentColor or Color3.fromRGB(150, 150, 150)
            p.Label.TextColor3 = (n == name) and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(150, 150, 150)
        end
    end)
    
    local count = 0
    for _ in pairs(Pages) do count = count + 1 end
    TabFrame.Position = UDim2.new(0, (count - 1) * 130, 0, 0)
    
    return LeftCol, RightCol
end

local PhysLeft, PhysRight = CreateTab("Physics", "rbxassetid://6034509923")
local SettLeft, SettRight = CreateTab("Settings", "rbxassetid://6031280882")

Pages["Physics"].Page.Visible = true
Pages["Physics"].Btn.BackgroundColor3 = Color3.fromRGB(25, 22, 30)
Pages["Physics"].Icon.ImageColor3 = Settings.AccentColor
Pages["Physics"].Label.TextColor3 = Color3.fromRGB(255, 255, 255)

-- [[ COMPONENT CREATORS ]] --
local function CreateLabel(parent, text)
    local Label = Instance.new("TextLabel", parent)
    Label.Text = text
    Label.Size = UDim2.new(1, 0, 0, 20)
    Label.BackgroundTransparency = 1
    Label.TextColor3 = Settings.TextColorDim 
    Label.Font = Enum.Font.GothamBold
    Label.TextSize = 12
    Label.TextXAlignment = Enum.TextXAlignment.Left
    return Label
end

local function CreateToggle(parent, name, settingName, callback)
    local default = Settings[settingName]
    local Container = Instance.new("Frame", parent)
    Container.Size = UDim2.new(1, 0, 0, 42)
    Container.BackgroundColor3 = Settings.ContainerColor
    Instance.new("UICorner", Container).CornerRadius = UDim.new(0, 10)
    
    local Label = Instance.new("TextLabel", Container)
    Label.Text = name
    Label.Size = UDim2.new(0.7, 0, 1, 0)
    Label.Position = UDim2.new(0, 12, 0, 0)
    Label.TextColor3 = Color3.fromRGB(200, 200, 200)
    Label.Font = Enum.Font.GothamMedium
    Label.TextSize = 13
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.BackgroundTransparency = 1
    
    local ToggleFrame = Instance.new("Frame", Container)
    ToggleFrame.Size = UDim2.new(0, 40, 0, 20)
    ToggleFrame.Position = UDim2.new(1, -52, 0.5, -10)
    ToggleFrame.BackgroundColor3 = default and Settings.AccentColor or Color3.fromRGB(45, 45, 50)
    Instance.new("UICorner", ToggleFrame).CornerRadius = UDim.new(1, 0)
    
    local Circle = Instance.new("Frame", ToggleFrame)
    Circle.Size = UDim2.new(0, 16, 0, 16)
    Circle.Position = default and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
    Circle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    Instance.new("UICorner", Circle).CornerRadius = UDim.new(1, 0)
    
    local Button = Instance.new("TextButton", Container)
    Button.Size = UDim2.new(1, 0, 1, 0)
    Button.BackgroundTransparency = 1
    Button.Text = ""
    
    local function UpdateState(state)
        Settings[settingName] = state
        local targetColor = state and Settings.AccentColor or Color3.fromRGB(45, 45, 50)
        local targetPos = state and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
        TweenService:Create(ToggleFrame, TweenInfo.new(0.25), {BackgroundColor3 = targetColor}):Play()
        TweenService:Create(Circle, TweenInfo.new(0.25), {Position = targetPos}):Play()
        if callback then callback(state) end
    end
    
    Button.MouseButton1Click:Connect(function() UpdateState(not Settings[settingName]) end)
    UIElements.Toggles[settingName] = UpdateState
    return UpdateState
end

local function CreateSlider(parent, name, settingName, min, max, callback)
    local default = Settings[settingName]
    local Container = Instance.new("Frame", parent)
    Container.Size = UDim2.new(1, 0, 0, 50)
    Container.BackgroundColor3 = Settings.ContainerColor
    Instance.new("UICorner", Container).CornerRadius = UDim.new(0, 10)
    
    local Label = Instance.new("TextLabel", Container)
    Label.Text = name
    Label.Size = UDim2.new(1, 0, 0, 24)
    Label.Position = UDim2.new(0, 12, 0, 2)
    Label.TextColor3 = Color3.fromRGB(200, 200, 200)
    Label.Font = Enum.Font.GothamMedium
    Label.TextSize = 13
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.BackgroundTransparency = 1
    
    local ValLbl = Instance.new("TextLabel", Container)
    ValLbl.Text = tostring(default)
    ValLbl.Size = UDim2.new(1, -24, 0, 24)
    ValLbl.Position = UDim2.new(0, 0, 0, 2)
    ValLbl.TextColor3 = Color3.fromRGB(255, 255, 255)
    ValLbl.Font = Enum.Font.GothamBold
    ValLbl.TextSize = 13
    ValLbl.TextXAlignment = Enum.TextXAlignment.Right
    ValLbl.BackgroundTransparency = 1
    
    local SliderTrack = Instance.new("Frame", Container)
    SliderTrack.Size = UDim2.new(1, -24, 0, 4)
    SliderTrack.Position = UDim2.new(0, 12, 0, 32)
    SliderTrack.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    Instance.new("UICorner", SliderTrack).CornerRadius = UDim.new(1, 0)
    
    local SliderFill = Instance.new("Frame", SliderTrack)
    local startPct = (default - min) / (max - min)
    SliderFill.Size = UDim2.new(startPct, 0, 1, 0)
    SliderFill.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    Instance.new("UICorner", SliderFill).CornerRadius = UDim.new(1, 0)
    
    local Grad = Instance.new("UIGradient", SliderFill)
    Grad.Color = ColorSequence.new{ColorSequenceKeypoint.new(0, Settings.Gradient1), ColorSequenceKeypoint.new(1, Settings.Gradient2)}
    
    local Knob = Instance.new("Frame", SliderFill)
    Knob.Size = UDim2.new(0, 12, 0, 12)
    Knob.Position = UDim2.new(1, -6, 0.5, -6)
    Knob.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    Instance.new("UICorner", Knob).CornerRadius = UDim.new(1, 0)
    
    local Trigger = Instance.new("TextButton", Container)
    Trigger.Size = UDim2.new(1, 0, 1, 0)
    Trigger.BackgroundTransparency = 1
    Trigger.Text = ""
    
    local function SetValue(val)
        val = math.clamp(val, min, max)
        local pct = (val - min) / (max - min)
        SliderFill.Size = UDim2.new(pct, 0, 1, 0)
        local display = math.floor(val * 100) / 100
        ValLbl.Text = tostring(display)
        Settings[settingName] = val
        if callback then callback(val) end
    end
    
    local dragging = false
    Trigger.MouseButton1Down:Connect(function() dragging = true end)
    UserInputService.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
    RunService.RenderStepped:Connect(function()
        if dragging then
            local mouseX = UserInputService:GetMouseLocation().X
            local relX = mouseX - SliderTrack.AbsolutePosition.X
            local p = math.clamp(relX / SliderTrack.AbsoluteSize.X, 0, 1)
            SetValue(min + (max - min) * p)
        end
    end)
    UIElements.Sliders[settingName] = SetValue
end

local function CreateKeybind(parent, settingName, labelText, callback)
    local Container = Instance.new("Frame", parent)
    Container.Size = UDim2.new(1, 0, 0, 36)
    Container.BackgroundColor3 = Settings.ContainerColor
    Instance.new("UICorner", Container).CornerRadius = UDim.new(0, 10)
    
    local Label = Instance.new("TextLabel", Container)
    Label.Text = labelText or "Keybind"
    Label.Size = UDim2.new(0.5, 0, 1, 0)
    Label.Position = UDim2.new(0, 12, 0, 0)
    Label.TextColor3 = Settings.TextColorDim
    Label.Font = Enum.Font.GothamMedium
    Label.TextSize = 13
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.BackgroundTransparency = 1
    
    local KeyButton = Instance.new("TextButton", Container)
    KeyButton.Size = UDim2.new(0, 30, 0, 20)
    KeyButton.Position = UDim2.new(1, -42, 0.5, -10)
    KeyButton.BackgroundColor3 = Settings.ButtonColor
    KeyButton.Text = Settings[settingName].Name
    KeyButton.TextColor3 = Color3.fromRGB(200, 200, 200)
    KeyButton.Font = Enum.Font.GothamBold
    KeyButton.TextSize = 11
    Instance.new("UICorner", KeyButton).CornerRadius = UDim.new(0, 6)
    
    local listening = false
    KeyButton.MouseButton1Click:Connect(function()
        listening = true
        KeyButton.Text = "..."
        KeyButton.TextColor3 = Settings.AccentColor
    end)
    
    UserInputService.InputBegan:Connect(function(input)
        if listening and input.UserInputType == Enum.UserInputType.Keyboard then
            listening = false
            Settings[settingName] = input.KeyCode
            KeyButton.Text = input.KeyCode.Name
            KeyButton.TextColor3 = Color3.fromRGB(200, 200, 200)
            if callback then callback(input.KeyCode) end
        end
    end)
end

local function CreateButton(parent, text, callback)
    local Btn = Instance.new("TextButton", parent)
    Btn.Size = UDim2.new(1, 0, 0, 36)
    Btn.BackgroundColor3 = Settings.ContainerColor
    Btn.Text = text
    Btn.TextColor3 = Settings.AccentColor
    Btn.Font = Enum.Font.GothamBold
    Btn.TextSize = 13
    Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 10)
    
    Btn.MouseButton1Click:Connect(function()
        TweenService:Create(Btn, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(40, 40, 45)}):Play()
        task.wait(0.1)
        TweenService:Create(Btn, TweenInfo.new(0.1), {BackgroundColor3 = Settings.ContainerColor}):Play()
        callback()
    end)
end

local function CreateDropdown(parent, placeholder, refreshFunc)
    local Container = Instance.new("Frame", parent)
    Container.Size = UDim2.new(1, 0, 0, 36)
    Container.BackgroundColor3 = Settings.ContainerColor
    Container.ZIndex = 5 -- FIX: Raised ZIndex to float over other buttons
    Instance.new("UICorner", Container).CornerRadius = UDim.new(0, 10)
    
    local MainBtn = Instance.new("TextButton", Container)
    MainBtn.Size = UDim2.new(1, 0, 1, 0)
    MainBtn.BackgroundTransparency = 1
    MainBtn.Text = placeholder
    MainBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
    MainBtn.Font = Enum.Font.GothamBold
    MainBtn.TextSize = 12
    MainBtn.ZIndex = 6
    
    local Arrow = Instance.new("TextLabel", Container)
    Arrow.Text = "v"
    Arrow.Size = UDim2.new(0, 30, 1, 0)
    Arrow.Position = UDim2.new(1, -30, 0, 0)
    Arrow.BackgroundTransparency = 1
    Arrow.TextColor3 = Settings.AccentColor
    Arrow.Font = Enum.Font.GothamBold
    Arrow.TextSize = 12
    Arrow.ZIndex = 6
    
    local List = Instance.new("ScrollingFrame", Container)
    List.Size = UDim2.new(1, 0, 0, 100)
    List.Position = UDim2.new(0, 0, 1, 5)
    List.BackgroundColor3 = Color3.fromRGB(25, 25, 28)
    List.BorderSizePixel = 0
    List.Visible = false
    List.ZIndex = 10 -- FIX: Highest ZIndex for list
    List.ScrollBarThickness = 2
    Instance.new("UICorner", List).CornerRadius = UDim.new(0, 6)
    
    local Layout = Instance.new("UIListLayout", List)
    Layout.SortOrder = Enum.SortOrder.LayoutOrder
    
    local function Refresh()
        for _, v in pairs(List:GetChildren()) do if v:IsA("TextButton") then v:Destroy() end end
        for name, _ in pairs(ConfigList) do
            local Item = Instance.new("TextButton", List)
            Item.Size = UDim2.new(1, 0, 0, 25)
            Item.BackgroundTransparency = 1
            Item.Text = name
            Item.TextColor3 = Color3.fromRGB(200, 200, 200)
            Item.Font = Enum.Font.Gotham
            Item.TextSize = 12
            Item.ZIndex = 11
            Item.MouseButton1Click:Connect(function()
                SelectedConfig = name
                MainBtn.Text = name
                List.Visible = false
                Container.Size = UDim2.new(1, 0, 0, 36)
            end)
        end
        List.CanvasSize = UDim2.new(0, 0, 0, Layout.AbsoluteContentSize.Y)
    end
    
    MainBtn.MouseButton1Click:Connect(function()
        List.Visible = not List.Visible
        if List.Visible then Refresh() end
    end)
    
    if refreshFunc then refreshFunc(Refresh) end
end

-- [[ BUILD PHYSICS TAB ]] --
local function LongArmsLogic(v, reach)
    if not LocalPlayer.Character then return end
    local left, right = LocalPlayer.Character:FindFirstChild("Left Arm"), LocalPlayer.Character:FindFirstChild("Right Arm")
    if left and right then
        if v then
            left.Size = Vector3.new(reach, 2, 1); right.Size = Vector3.new(reach, 2, 1)
            left.CanCollide = false; right.CanCollide = false
            left.Massless = true; right.Massless = true
        else
            left.Size = Vector3.new(1, 2, 1); right.Size = Vector3.new(1, 2, 1)
            left.CanCollide = true; right.CanCollide = true
            left.Massless = false; right.Massless = false
        end
    end
end

CreateToggle(PhysLeft, "Ball Reach", "BallReach", function(v) LongArmsLogic(v, Settings.ReachDistance) end)
CreateSlider(PhysLeft, "Reach Distance", "ReachDistance", 0, 15, function(v) if Settings.BallReach then LongArmsLogic(true, v) end end)
CreateSlider(PhysLeft, "WalkSpeed", "WalkSpeed", 16, 50, function(v) end)

local UpdateGuard = CreateToggle(PhysRight, "Auto Guard", "AutoGuard", function(v) end)
CreateKeybind(PhysRight, "AutoGuardKey", "Keybind", function(k) end) 
CreateSlider(PhysRight, "Guard Delay", "GuardDelay", 0, 1, function(v) end)

CreateToggle(PhysRight, "Auto Power", "AutoPower", function(v) end)
CreateToggle(PhysRight, "Auto Shoot", "AutoShoot", function(v) end)
CreateSlider(PhysRight, "Shoot Delay", "JumpDelay", 0, 0.5, function(v) end)

-- [[ BUILD SETTINGS TAB ]] --
CreateLabel(SettLeft, "Utilities")
CreateButton(SettLeft, "Infinite Yield", function() loadstring(game:HttpGet('https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source'))() end)
CreateButton(SettLeft, "Rejoin Server", function() game:GetService("TeleportService"):Teleport(game.PlaceId, LocalPlayer) end)

CreateLabel(SettLeft, "Visuals & World")
CreateToggle(SettLeft, "Show Hitboxes", "ShowHitboxes", function(v)
    if not v then
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character then
                for _, partName in pairs({"Jersey", "Hitbox", "HumanoidRootPart"}) do
                    local part = p.Character:FindFirstChild(partName)
                    if part then part.Transparency = 1 end
                end
            end
        end
    end
end)
CreateToggle(SettLeft, "Hitbox Expander (Self)", "HBEEnabled", function(v) end)
CreateSlider(SettLeft, "HBE Size", "HBESize", 0, 10, function(v) end)
CreateSlider(SettLeft, "World Time", "WorldTime", 0, 24, function(v) Lighting.ClockTime = v end)
CreateSlider(SettLeft, "Brightness", "Brightness", 0, 10, function(v) Lighting.Brightness = v end)

CreateLabel(SettRight, "Player Protection")
CreateToggle(SettRight, "Anti-Knock", "AntiKnock", function(v) end)
CreateToggle(SettRight, "Big Head All", "BigHead", function(v) end)
CreateToggle(SettRight, "Trucking Mode (Hold F)", "TruckEnabled", function(v) end)

CreateLabel(SettRight, "Menu Settings")
CreateKeybind(SettRight, "MenuKey", "Toggle UI", function(k) end)

CreateLabel(SettRight, "Configuration")
local ConfigNameInput = Instance.new("TextBox", SettRight)
ConfigNameInput.Size = UDim2.new(1, 0, 0, 36)
ConfigNameInput.BackgroundColor3 = Color3.fromRGB(25, 25, 28)
ConfigNameInput.PlaceholderText = "Config Name..."
ConfigNameInput.Text = ""
ConfigNameInput.TextColor3 = Color3.new(1,1,1)
ConfigNameInput.Font = Enum.Font.Gotham
ConfigNameInput.TextSize = 13
Instance.new("UICorner", ConfigNameInput).CornerRadius = UDim.new(0, 10)

CreateButton(SettRight, "Create Config", function()
    local name = ConfigNameInput.Text
    if name ~= "" then
        ConfigList[name] = Settings
        SaveConfigs()
    end
end)

local RefreshDropdown
CreateDropdown(SettRight, "Select Config...", function(ref) RefreshDropdown = ref end)

CreateButton(SettRight, "Load Config", function()
    if SelectedConfig and ConfigList[SelectedConfig] then
        ApplyConfig(SelectedConfig)
    end
end)

CreateButton(SettRight, "Overwrite Config", function()
    if SelectedConfig then
        ConfigList[SelectedConfig] = Settings
        SaveConfigs()
    end
end)

CreateButton(SettRight, "Delete Config", function()
    if SelectedConfig then
        ConfigList[SelectedConfig] = nil
        SaveConfigs()
        if RefreshDropdown then RefreshDropdown() end
    end
end)

-- [[ LISTENERS ]] --
UserInputService.InputBegan:Connect(function(input, gpe)
    if not gpe then
        if input.KeyCode == Settings.MenuKey then Main.Visible = not Main.Visible end
        if input.KeyCode == Settings.AutoGuardKey then UpdateGuard(not Settings.AutoGuard) end
        if Settings.TruckEnabled and input.KeyCode == Enum.KeyCode.F then
            local char = LocalPlayer.Character
            if char and char:FindFirstChild("Jersey") then
                local evt = char.Jersey:FindFirstChild("Event")
                if evt then evt:FireServer({[1] = "Truck"}) end
            end
        end
    end
end)

UserInputService.InputEnded:Connect(function(input, gpe)
    if Settings.TruckEnabled and input.KeyCode == Enum.KeyCode.F then
        local char = LocalPlayer.Character
        if char and char:FindFirstChild("Jersey") then
            local evt = char.Jersey:FindFirstChild("Event")
            if evt then evt:FireServer({[1] = "StopTruck"}) end
        end
    end
end)

LoadConfigsFromFile()

-- [[ LOGIC CORE - STABILITY FIX ]] --
local CachedHoops = {}
local LastScanTime = 0
local LastGuardUpdate = 0
local LockedPower = nil 
local CurrentTarget = nil 

local function UpdateHoopCache()
    if tick() - LastScanTime > 2 then
        LastScanTime = tick()
        CachedHoops = {}
        for _, v in pairs(Workspace:GetDescendants()) do
            if v:IsA("BasePart") and (v.Name == "Goal" or v.Name == "Rim" or v.Name == "Hoop") then
                table.insert(CachedHoops, v)
            end
        end
    end
end

local function GetClosestHoop()
    UpdateHoopCache()
    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not root then return nil end
    local closest, minDist = nil, math.huge
    for _, hoop in pairs(CachedHoops) do
        if hoop and hoop.Parent then
            local dist = (root.Position - hoop.Position).Magnitude
            if dist < minDist and dist < 160 then minDist = dist closest = hoop end
        end
    end
    return closest
end

-- THREADED SCANNER
task.spawn(function()
    while true do
        task.wait(0.1) 
        if Settings.AutoGuard and LocalPlayer.Character then
            local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if root then
                local amIHolding = LocalPlayer.Character:FindFirstChild("Basketball") or LocalPlayer.Character:FindFirstChild("Ball") or LocalPlayer.Character:FindFirstChildOfClass("Tool")
                if amIHolding then
                    CurrentTarget = nil
                else
                    local closest, dist = nil, math.huge
                    for _, p in pairs(Players:GetPlayers()) do
                        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                            local hasBall = p.Character:FindFirstChild("Basketball") or p.Character:FindFirstChild("Ball") or p.Character:FindFirstChildOfClass("Tool")
                            if hasBall then
                                local d = (root.Position - p.Character.HumanoidRootPart.Position).Magnitude
                                if d < dist then dist = d closest = p.Character.HumanoidRootPart end
                            end
                        end
                    end
                    CurrentTarget = closest
                end
            end
        else
            CurrentTarget = nil
        end
    end
end)

local function SolveV104(hoop, char)
    local head = char:FindFirstChild("Head")
    local root = char:FindFirstChild("HumanoidRootPart")
    if not head or not root then return nil, nil end
    local g, t, target = Settings.Gravity, Settings.FlightTime, hoop.CFrame.Position
    local dir = (target - head.Position).Unit
    local spawnPos = root.Position + (dir * 5)
    local neededVel = (target - spawnPos - Vector3.new(0, -0.5*g*t*t, 0)) / t
    local rawVec = neededVel - Vector3.new(0, Settings.ServerBoost, 0)
    local pwr = math.floor((rawVec.Magnitude / Settings.StepSize) + 0.5) * Settings.StepSize
    return head.Position + (rawVec.Unit * 100), math.clamp(pwr, 20, 100)
end

-- STABLE SYNC (NO BOUNCE)
local Syncing = false
local function TurboSync(target)
    if Syncing then return end Syncing = true
    local char = LocalPlayer.Character
    local pVal = char and char:FindFirstChild("PowerValue")
    local start = tick()
    
    -- Increase deadzone to 4 to stop fighting
    while pVal and math.abs(pVal.Value - target) > 4 and (tick() - start) < 0.5 do 
        local diff = target - pVal.Value
        local key = (diff > 0) and Enum.KeyCode.E or Enum.KeyCode.Q
        VIM:SendKeyEvent(true, key, false, game)
        task.wait(0.1) -- SLOW TAP
        VIM:SendKeyEvent(false, key, false, game)
    end
    Syncing = false
end

UserInputService.JumpRequest:Connect(function()
    if Settings.AutoShoot or Settings.AutoPower then
        local hoop = GetClosestHoop()
        if hoop and LocalPlayer.Character then
            local _, pwr = SolveV104(hoop, LocalPlayer.Character)
            LockedPower = pwr
            task.delay(1, function() LockedPower = nil end)
        end
    end
end)

RunService.Heartbeat:Connect(function()
    local char = LocalPlayer.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    local hum = char:FindFirstChild("Humanoid")
    
    if hum and Settings.WalkSpeed ~= 16 then hum.WalkSpeed = Settings.WalkSpeed end

    -- Auto Guard
    if Settings.AutoGuard and root and hum then
        if tick() - LastGuardUpdate > Settings.GuardDelay then
            LastGuardUpdate = tick()
            if CurrentTarget then
                hum:MoveTo(CurrentTarget.Position)
                local lookPos = Vector3.new(CurrentTarget.Position.X, root.Position.Y, CurrentTarget.Position.Z)
                root.CFrame = root.CFrame:Lerp(CFrame.lookAt(root.Position, lookPos), 0.25)
            else
                hum:MoveTo(root.Position)
            end
        end
    end

    -- Hitbox Expander & Anti-Knock
    if Settings.HBEEnabled then
        for _, partName in pairs({"Hitbox", "Jersey", "UpperJersey", "LowerJersey"}) do
            local part = char:FindFirstChild(partName)
            if part then
                part.Size = Vector3.new(Settings.HBESize, Settings.HBESize, Settings.HBESize)
                part.CanCollide = false
                part.Transparency = Settings.ShowHitboxes and 0.5 or 1
            end
        end
    end
    if Settings.AntiKnock then
        local l, r = char:FindFirstChild("Left Arm"), char:FindFirstChild("Right Arm")
        if l and r then l.Size = Vector3.new(1,2,1) r.Size = Vector3.new(1,2,1) end
    end

    -- Shooting
    local hoop = GetClosestHoop()
    if hoop then
        local aim, pwr
        local state = hum:GetState()
        local isAirborne = (state == Enum.HumanoidStateType.Jumping or state == Enum.HumanoidStateType.Freefall)
        
        -- Use Locked Power if Airborne
        if isAirborne and LockedPower then 
            pwr = LockedPower; 
            local r, _ = SolveV104(hoop, char); 
            aim = r 
        else 
            aim, pwr = SolveV104(hoop, char) 
        end

        if aim and pwr then
            if Settings.AutoPower and not _G.ShotCooldown then task.spawn(function() TurboSync(pwr) end) end
            if Settings.AutoShoot then
                local dist = (root.Position - hoop.Position).Magnitude
                if dist > Settings.DunkDistance then 
                    if isAirborne and not _G.ShotCooldown then
                        local tool = char:FindFirstChildOfClass("Tool")
                        local pVal = char:FindFirstChild("PowerValue")
                        if tool and tool:FindFirstChild("ShootEvent") and pVal then
                            -- Wait for stability (diff < 5)
                            if math.abs(pVal.Value - pwr) < 5 then 
                                _G.ShotCooldown = true
                                task.wait(Settings.JumpDelay)
                                task.delay(0.8, function() _G.ShotCooldown = false end)
                                local anim = tool:FindFirstChild("Animations") and tool.Animations:FindFirstChild("Shoot")
                                if anim then hum:LoadAnimation(anim):Play() end
                                tool.ShootEvent:FireServer(hum, aim)
                            end
                        end
                    end
                end
            end
        end
    end
end)

-- SLOW VISUALS LOOP
task.spawn(function()
    while true do
        task.wait(1)
        if Settings.ShowHitboxes then
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= LocalPlayer and p.Character then
                    for _, partName in pairs({"Jersey", "Hitbox", "HumanoidRootPart"}) do
                        local part = p.Character:FindFirstChild(partName)
                        if part then part.Transparency = 0.5 part.Color = Settings.AccentColor part.Material = Enum.Material.Neon end
                    end
                    if Settings.BigHead and p.Character:FindFirstChild("Head") then
                        p.Character.Head.Size = Vector3.new(4, 4, 4)
                        p.Character.Head.Transparency = 0.5
                        p.Character.Head.CanCollide = false
                    end
                end
            end
        end
    end
end)
